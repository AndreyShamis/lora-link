# Auto-ASA: Автоматическая адаптация профилей

## Обзор

Auto-ASA (Automatic Adaptive Settings Adjustment) - система автоматического выбора и переключения LoRa/FSK профилей на основе качества связи с клиентами.

### Как это работает:

1. **Мониторинг клиентов**: Система непрерывно отслеживает RSSI и SNR каждого активного клиента
2. **Анализ качества связи**: На основе **отфильтрованного RSSI клиента** определяется оптимальный профиль из таблицы `rssiToProfileTable`
3. **Отправка ASA запросов**: Если рекомендуемый профиль для клиента отличается от последнего рекомендованного - отправляется ASA запрос **этому клиенту**
4. **Гистерезис**: Предотвращает частые переключения при незначительных изменениях RSSI

**Важно**: Мастер анализирует RSSI **каждого клиента** и предлагает **ему** оптимальный профиль. Например:
- Клиент А (RSSI=-78 dBm) → Мастер предлагает профиль 11 (GFSK fast)
- Клиент Б (RSSI=-115 dBm) → Мастер предлагает профиль 2 (LoRa reliable)

### Схема работы:

```
┌──────────┐                    ┌──────────┐                    ┌──────────┐
│ Клиент A │                    │  Мастер  │                    │ Клиент B │
│ (близко) │                    │          │                    │ (далеко) │
└──────────┘                    └──────────┘                    └──────────┘
     │                                │                                │
     │   Packet (RSSI=-78 dBm)       │                                │
     ├──────────────────────────────>│                                │
     │                                │   Packet (RSSI=-115 dBm)      │
     │                                │<───────────────────────────────┤
     │                                │                                │
     │                                │ Auto-ASA анализ:               │
     │                                │ • Client A: -78 → Profile 11   │
     │                                │ • Client B: -115 → Profile 2   │
     │                                │                                │
     │   ASA Request (Profile 11)    │                                │
     │<──────────────────────────────┤                                │
     │                                │    ASA Request (Profile 2)     │
     │                                ├───────────────────────────────>│
     │                                │                                │
     │   ASA Response (OK)            │                                │
     ├──────────────────────────────>│                                │
     │                                │        ASA Response (OK)       │
     │                                │<───────────────────────────────┤
     │                                │                                │
     │   [Переключение на Profile 11] │  [Переключение на Profile 2]  │
     │                                │                                │
```

**Результат**: Каждый клиент работает на оптимальном для **его** условий профиле!

## Таблица маппинга RSSI → Профиль

```cpp
{ RSSI,     SNR,    Profile }
{ -75.0f,  10.0f,   12 },  // Maximum GFSK speed
{ -80.0f,   8.0f,   11 },  // GFSK fast
{ -85.0f,   6.0f,   10 },  // GFSK medium
{ -90.0f,   4.0f,    9 },  // GFSK conservative
{ -95.0f,   2.0f,    8 },  // LoRa maximum speed
{-100.0f,   0.0f,    7 },  // LoRa very fast
{-105.0f,  -2.0f,    6 },  // LoRa speed + range
{-110.0f,  -4.0f,    5 },  // LoRa fast
{-114.0f,  -6.0f,    4 },  // LoRa medium
{-116.0f,  -8.0f,    3 },  // LoRa medium mode
{-118.0f, -10.0f,    2 },  // LoRa reliable
{-119.0f, -12.0f,    1 },  // LoRa very good stability
{-120.0f, -15.0f,    0 }   // LoRa maximum reliability
```

## Настройки

### Параметры конфигурации

```cpp
bool autoAsaEnabled                  // Вкл/выкл Auto-ASA (по умолчанию: false)
unsigned long autoAsaCheckInterval   // Интервал проверки в мс (по умолчанию: 10000)
float autoAsaRssiHysteresis          // Гистерезис RSSI в dBm (по умолчанию: 5.0)
```

**Изменения в v1.1:**
- Гистерезис увеличен с 3.0 до **5.0 dBm** для предотвращения частых переключений
- Добавлена проверка валидности SNR (игнорируется если SNR < -15 или > 20)
- При невалидном SNR используется **только RSSI** для выбора профиля

### Гистерезис RSSI

Предотвращает "дрожание" профилей при незначительных колебаниях сигнала:

```
Пример с hysteresis = 5.0 dBm:

Текущий профиль для клиента: 5 (порог -110 dBm)
RSSI клиента: -112 dBm
Изменение: |-112 - (-110)| = 2 dBm < 5 dBm → профиль НЕ меняется

RSSI клиента: -104 dBm  
Изменение: |-104 - (-110)| = 6 dBm > 5 dBm → профиль меняется на 6
```

### Проверка валидности SNR

SNR может быть невалидным (например, -20.0 после инициализации). В таких случаях:
- **SNR игнорируется** если значение < -15 или > 20
- Используется **только RSSI** для выбора профиля
- В логе появляется метка `[SNR?]`

Пример лога с невалидным SNR:
```
[AutoASA] Client 2: RSSI=-28.3 SNR=-20.0 [SNR?] → Profile 9 (was 0)
```

## API методы

### Управление Auto-ASA

```cpp
// Включить/выключить
void setAutoAsaEnabled(bool enabled);
bool isAutoAsaEnabled() const;

// Настройка интервала проверки (мс)
void setAutoAsaCheckInterval(unsigned long intervalMs);
unsigned long getAutoAsaCheckInterval() const;

// Настройка гистерезиса (dBm)
void setAutoAsaRssiHysteresis(float hysteresis);
float getAutoAsaRssiHysteresis() const;

// Рекомендовать профиль для конкретного клиента
uint8_t recommendProfileForClient(LoraAddress_t clientAddr);

// Проверить всех клиентов и отправить ASA (вызывается автоматически)
void checkAndSendAutoAsa();
```

## Использование

### Включение Auto-ASA

```cpp
// В коде
lora->setAutoAsaEnabled(true);
lora->setAutoAsaCheckInterval(15000);  // Проверка каждые 15 секунд
lora->setAutoAsaRssiHysteresis(2.5f);  // Гистерезис 2.5 dBm
```

### Команды в Master Node

```bash
# Включить/выключить
> autoasa on
✓ Auto-ASA enabled

> autoasa off
✓ Auto-ASA disabled

# Настройка интервала (в миллисекундах)
> autoasa interval 20000
✓ Auto-ASA interval set to 20000 ms

# Настройка гистерезиса (в dBm)
> autoasa hysteresis 2.0
✓ Auto-ASA hysteresis set to 2.0 dBm

# Проверка статуса
> autoasa status

=== Auto-ASA Status ===
Enabled: Yes
Check interval: 20000 ms
RSSI hysteresis: 2.0 dBm
=======================
```

## Логика работы

### Алгоритм выбора профиля

1. **Получить информацию о клиенте**
   - Если клиент не найден → использовать текущий профиль
   - Если не получали пакетов от клиента → пропустить (нет данных)

2. **Проверить гистерезис**
   - Если уже был рекомендован профиль для этого клиента
   - И RSSI изменился < hysteresis → оставить старый профиль

3. **Поиск в таблице**
   - Проверяем условия: `rssi >= minRssi && snr >= minSnr`
   - Возвращаем первый подходящий профиль (от лучшего к худшему)
   - Если ничего не подошло → профиль 0 (максимальная надёжность)

4. **Отправка ASA запроса**
   - Если рекомендованный профиль ≠ последний рекомендованный для этого клиента
   - Отправляем `sendAsaRequest(recommendedProfile, clientAddr)` **клиенту**
   - Сохраняем `lastRecommendedProfile[clientAddr] = recommendedProfile`

### Условия отправки ASA

Auto-ASA отправляет запросы только для клиентов, которые:

- ✅ `hasReceivedPackets == true` (получали хотя бы 1 пакет)
- ✅ `isActive(30000)` (видели в последние 30 секунд)
- ✅ Рекомендуемый профиль отличается от последнего рекомендованного **для этого клиента**

**Ключевой момент**: Каждый клиент получает рекомендацию на основе **своего** RSSI, а не общего профиля мастера!

## Логирование

При отправке ASA запроса в лог добавляется запись:

```
[AutoASA] Client 2: RSSI=-78.5 SNR=9.2 → Recommend Profile 11 (was 5)
```

Формат:
- **Client**: Адрес клиента
- **RSSI**: Отфильтрованное значение RSSI **этого клиента**
- **SNR**: SNR **этого клиента**
- **Recommend Profile**: Рекомендуемый профиль на основе RSSI клиента
- **was**: Последний рекомендованный профиль для этого клиента (или 0 при первой рекомендации)

## Примеры сценариев

### Сценарий 1: Клиент приближается (улучшается сигнал)

```
Клиент 2 движется к мастеру:

t=0s:   RSSI=-118 dBm, SNR=-10 → Рекомендуем Profile 2 (LoRa reliable)
        [AutoASA] Client 2: RSSI=-118.0 SNR=-10.0 → Recommend Profile 2 (was 0)
        
t=10s:  RSSI=-110 dBm, SNR=-4  → Рекомендуем Profile 5 (LoRa fast)
        [AutoASA] Client 2: RSSI=-110.0 SNR=-4.0 → Recommend Profile 5 (was 2)
        
t=20s:  RSSI=-108 dBm, SNR=-3  → Профиль 5 (гистерезис, не меняем)
        Нет лога - рекомендация не изменилась
        
t=30s:  RSSI=-95 dBm, SNR=2    → Рекомендуем Profile 8 (LoRa max speed)
        [AutoASA] Client 2: RSSI=-95.0 SNR=2.0 → Recommend Profile 8 (was 5)
        
t=40s:  RSSI=-78 dBm, SNR=9    → Рекомендуем Profile 11 (GFSK fast)
        [AutoASA] Client 2: RSSI=-78.0 SNR=9.0 → Recommend Profile 11 (was 8)
```

**Объяснение**: По мере улучшения сигнала клиент получает рекомендации на более быстрые профили.

### Сценарий 2: Стабильная связь с колебаниями

```
RSSI колеблется: -112, -110, -113, -109, -111 dBm
Профиль 5 (порог -110 dBm)
Гистерезис 3.0 dBm

Все изменения < 3 dBm от -110 → профиль НЕ меняется
Избегаем постоянных переключений
```

### Сценарий 3: Несколько клиентов с разным RSSI

```
Мастер работает с двумя клиентами одновременно:

Клиент 2: RSSI=-78 dBm, SNR=9    → Рекомендуем Profile 11 (GFSK fast)
Клиент 5: RSSI=-115 dBm, SNR=-8  → Рекомендуем Profile 2 (LoRa reliable)

Логи:
[AutoASA] Client 2: RSSI=-78.0 SNR=9.0 → Recommend Profile 11 (was 0)
[AutoASA] Client 5: RSSI=-115.0 SNR=-8.0 → Recommend Profile 2 (was 0)

Результат: 
- Клиент 2 получает ASA запрос с профилем 11 (быстрый)
- Клиент 5 получает ASA запрос с профилем 2 (надёжный)
- Каждый работает на оптимальном для него профиле!
```

**Объяснение**: Мастер адаптирует профиль **индивидуально** для каждого клиента на основе его RSSI.

## Требования к ресурсам

### CPU
- Задача `AutoASA`: приоритет 1, стек 4KB
- Проверка каждую секунду (sleep 1000ms)
- Реальная работа только если `autoAsaEnabled == true`

### RAM
- `std::map<LoraAddress_t, uint8_t>` для хранения последних профилей
- ~24 байта на клиента
- Для 10 клиентов: ~240 байт

### Нагрузка на сеть
- Интервал проверки: 10-30 секунд (настраивается)
- ASA запрос отправляется только при изменении рекомендации
- Гистерезис минимизирует количество ASA запросов

## Рекомендации по настройке

### Оптимальные значения

| Параметр | Значение | Применение |
|----------|----------|------------|
| **Interval** | 10000 ms | Стандартная работа |
| **Interval** | 5000 ms | Мобильные клиенты (быстрое перемещение) |
| **Interval** | 30000 ms | Стационарные клиенты |
| **Hysteresis** | 5.0 dBm | Баланс (рекомендуется) |
| **Hysteresis** | 3.0 dBm | Быстрая адаптация (больше переключений) |
| **Hysteresis** | 7.0 dBm | Медленная адаптация (меньше переключений) |

### Для разных сценариев

**Мобильные устройства** (дрон, автомобиль):
```cpp
lora->setAutoAsaCheckInterval(5000);   // Быстрая проверка
lora->setAutoAsaRssiHysteresis(3.0f);  // Быстрая адаптация
```

**Стационарные узлы**:
```cpp
lora->setAutoAsaCheckInterval(30000);  // Редкая проверка
lora->setAutoAsaRssiHysteresis(7.0f);  // Стабильность
```

**Высокая нагрузка на сеть**:
```cpp
lora->setAutoAsaCheckInterval(60000);  // Минимум запросов
lora->setAutoAsaRssiHysteresis(7.0f);  // Минимум переключений
```

## Взаимодействие с ASA протоколом

Auto-ASA использует стандартный ASA механизм:

1. Мастер отправляет `CMD_REQUEST_ASA` со своим профилем
2. Клиент отвечает `CMD_RESPONCE_ASA` с подтверждением
3. Оба переключаются на новый профиль через `ASA_SWITCH_DELAY` (4 сек)
4. Продолжение работы на новом профиле

## Отладка

### Проверка работы Auto-ASA

```bash
# 1. Включить Auto-ASA
> autoasa on

# 2. Проверить статус
> autoasa status

# 3. Посмотреть клиентов и их RSSI
> clients

# 4. Следить за логами (будет показывать ASA запросы)
> log
```

### Ожидаемое поведение

- Каждые N секунд (interval) задача проверяет клиентов
- Если RSSI изменился достаточно (> hysteresis) → отправляется ASA
- В логе появляется `[AutoASA] Client X: RSSI=Y → Profile Z`
- Клиент получает ASA запрос и отвечает
- Оба переключаются на новый профиль

## Ограничения

1. **Только активные клиенты**: Auto-ASA не работает с клиентами, которые не отправляют пакеты
2. **Односторонняя адаптация**: Мастер предлагает профиль, но клиент тоже должен поддерживать ASA
3. **Задержка переключения**: 4 секунды (ASA_SWITCH_DELAY) после согласования
4. **Одновременные ASA**: Если несколько клиентов, ASA запросы отправляются последовательно

## Совместимость

- ✅ Работает со всеми профилями (LoRa 0-8, FSK 9-12)
- ✅ Совместимо с ручным ASA (`asa <profile>` команда)
- ✅ Совместимо с фильтром RSSI (использует отфильтрованное значение)
- ✅ Потокобезопасно (использует мьютексы)
